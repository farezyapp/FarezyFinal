<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Farezy - Compare Taxi & Rideshare Services</title>
    <meta name="description" content="Find the best priced and quickest ride options by comparing taxi and rideshare services in real-time based on your current location." />
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Farezy" />
    <meta name="mobile-web-app-capable" content="yes" />
    
    <!-- Open Graph tags -->
    <meta property="og:title" content="Farezy - Compare Taxi & Rideshare Services" />
    <meta property="og:description" content="Find the best priced and quickest ride options by comparing taxi and rideshare services in real-time." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="/icons/icon-512x512.png" />
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Farezy - Compare Ride Prices" />
    <meta name="twitter:description" content="Compare ride prices and find the best deals instantly" />
    <meta name="twitter:image" content="/icons/icon-512x512.png" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png" />
    <link rel="apple-touch-icon" sizes="128x128" href="/icons/icon-128x128.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  <script>
    // Farezy Driver App Integration Script
    class FarezyDriverService {
      constructor() {
        this.wsUrl = 'wss://farezydriver.replit.app/ws';
        this.ws = null;
        this.isConnected = false;
        this.passengerId = Math.floor(Math.random() * 900000) + 100000;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.callbacks = {
          onConnect: null,
          onDisconnect: null,
          onBookingResponse: null,
          onError: null
        };
      }

      // Initialize connection to driver app
      initialize(driverAppUrl, callbacks = {}) {
        if (driverAppUrl) {
          this.wsUrl = `wss://${driverAppUrl}/ws`;
        }
        this.callbacks = { ...this.callbacks, ...callbacks };
        console.log('Initializing Farezy Driver connection...');
        this.connect();
        return this;
      }

      connect() {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          console.log('Already connected to driver app');
          return;
        }

        console.log('Connecting to Farezy Driver App...');
        this.ws = new WebSocket(this.wsUrl);

        this.ws.onopen = () => {
          console.log('‚úÖ Connected to Farezy Driver App');
          this.isConnected = true;
          this.reconnectAttempts = 0;
          
          // Register as passenger
          this.ws.send(JSON.stringify({
            type: 'register',
            data: {
              userType: 'passenger',
              userId: this.passengerId
            }
          }));
          
          this.updateConnectionStatus(true);
          if (this.callbacks.onConnect) {
            this.callbacks.onConnect();
          }
        };

        this.ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          console.log('üì® Message from driver app:', message);
          this.handleMessage(message);
        };

        this.ws.onclose = () => {
          console.log('‚ùå Disconnected from driver app');
          this.isConnected = false;
          this.updateConnectionStatus(false);
          
          if (this.callbacks.onDisconnect) {
            this.callbacks.onDisconnect();
          }
          
          // Auto-reconnect
          if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.attemptReconnect();
          }
        };

        this.ws.onerror = (error) => {
          console.error('‚ùå Connection error:', error);
          this.updateConnectionStatus(false);
          if (this.callbacks.onError) {
            this.callbacks.onError(error);
          }
        };
      }

      handleMessage(message) {
        switch (message.type) {
          case 'registered':
            console.log('‚úÖ Successfully registered as passenger');
            break;
            
          case 'booking_accepted':
            console.log('üéâ Booking accepted by driver!');
            this.updateConnectionStatus(true);
            this.showDriverFound(message.data);
            if (this.callbacks.onBookingResponse) {
              this.callbacks.onBookingResponse(message);
            }
            break;
            
          case 'booking_rejected':
            console.log('‚ùå Booking rejected, looking for another driver...');
            this.showNoDrivers();
            if (this.callbacks.onBookingResponse) {
              this.callbacks.onBookingResponse(message);
            }
            break;
            
          case 'booking_forwarded':
            console.log(`üì° Booking forwarded to ${message.driversNotified} drivers`);
            if (message.driversNotified > 0) {
              this.showNotification(`Looking for drivers... (${message.driversNotified} drivers notified)`, 'info');
            } else {
              this.showNotification('No drivers available right now', 'warning');
            }
            break;
            
          case 'driver_location_update':
            this.updateDriverLocation(message.data);
            break;
            
          default:
            console.log('Unknown message type:', message.type);
        }
      }

      // Send booking request to available drivers
      send(data) {
        if (!this.isConnected) {
          console.error('‚ùå Not connected to driver network');
          this.showNotification('Not connected to driver network', 'error');
          return false;
        }

        this.ws.send(JSON.stringify(data));
        return true;
      }

      // Main function to request a ride
      requestRide(rideDetails) {
        console.log('üöó Requesting ride...', rideDetails);
        
        const bookingData = {
          type: 'booking_request',
          data: {
            passengerId: this.passengerId,
            passengerName: rideDetails.passengerName || 'Passenger',
            passengerPhone: rideDetails.passengerPhone || '+44',
            pickupAddress: rideDetails.pickupAddress || rideDetails.pickup,
            destinationAddress: rideDetails.destinationAddress || rideDetails.destination,
            pickupLat: rideDetails.pickupLat,
            pickupLng: rideDetails.pickupLng,
            destinationLat: rideDetails.destinationLat,
            destinationLng: rideDetails.destinationLng,
            estimatedFare: rideDetails.estimatedFare || rideDetails.estimatedPrice,
            distance: rideDetails.distance,
            serviceType: rideDetails.serviceType || 'standard'
          }
        };

        const success = this.send(bookingData);
        
        if (success) {
          console.log('‚úÖ Ride request sent to drivers');
          this.showNotification('Looking for available drivers...', 'info');
        }
        
        return success;
      }

      attemptReconnect() {
        this.reconnectAttempts++;
        console.log(`üîÑ Reconnecting... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
        
        setTimeout(() => {
          this.connect();
        }, 3000 * this.reconnectAttempts); // Exponential backoff
      }

      updateConnectionStatus(connected) {
        const statusElement = document.getElementById('farezy-driver-status');
        if (statusElement) {
          statusElement.textContent = connected ? 'Connected to drivers' : 'Connecting...';
          statusElement.className = connected ? 'connected' : 'disconnected';
        }
      }

      showDriverFound(driverData) {
        console.log('üöó Driver found:', driverData);
        this.showNotification(`Driver ${driverData?.driverName || 'assigned'} accepted your booking!`, 'success');
      }

      showNoDrivers() {
        console.log('‚ùå No drivers available');
        this.showNotification('No drivers available right now. Please try again.', 'warning');
      }

      updateDriverLocation(location) {
        console.log('üìç Driver location update:', location);
        // Update driver position on your map
      }

      showNotification(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      // Check connection status
      getConnectionStatus() {
        return {
          isConnected: this.isConnected,
          driverAppUrl: this.wsUrl,
          retries: this.reconnectAttempts
        };
      }

      // Disconnect from driver app
      disconnect() {
        if (this.ws) {
          this.ws.close();
          this.ws = null;
        }
        this.isConnected = false;
      }
    }

    // Make service globally available
    window.farezyDriverService = new FarezyDriverService();
    console.log('üöÄ Farezy Driver Service loaded and ready!');
    
    // Direct WebSocket connection to driver app
    let driverWs = null;
    
    function initializeDriverConnection() {
      driverWs = new WebSocket('wss://farezydriver.replit.app/ws');
      
      driverWs.onopen = function() {
        console.log('üîå Direct driver connection established');
        // Register as passenger
        driverWs.send(JSON.stringify({
          type: 'register',
          data: { userType: 'passenger', userId: 12345 }
        }));
      };
      
      driverWs.onmessage = function(event) {
        const message = JSON.parse(event.data);
        console.log('üì® Direct driver message:', message);
        
        if (message.type === 'registered') {
          console.log('‚úÖ Registered with direct driver connection');
        } else if (message.type === 'booking_forwarded') {
          console.log(`üì§ Booking forwarded to ${message.driversNotified} drivers`);
        } else if (message.type === 'booking_accepted') {
          console.log('üéâ Driver accepted booking via direct connection!');
          const driverInfo = message.data;
          alert(`üéâ Driver Found!\n\nDriver: ${driverInfo.driverName}\nPhone: ${driverInfo.driverPhone}\nVehicle: ${driverInfo.vehicleInfo}\nETA: ${driverInfo.estimatedArrival}`);
        } else if (message.type === 'booking_declined') {
          console.log('‚ùå Driver declined booking');
          alert('‚ùå Driver declined your booking. Looking for another driver...');
        }
      };
      
      driverWs.onclose = function() {
        console.log('‚ùå Direct driver connection closed');
        // Reconnect after 3 seconds
        setTimeout(initializeDriverConnection, 3000);
      };
      
      driverWs.onerror = function(error) {
        console.error('‚ùå Direct driver connection error:', error);
      };
    }
    
    // When user books a ride on farezy.co.uk
    function sendBooking(bookingData) {
      if (driverWs && driverWs.readyState === WebSocket.OPEN) {
        console.log('üì§ Sending booking via direct connection:', bookingData);
        driverWs.send(JSON.stringify({
          type: 'booking_request',
          data: bookingData
        }));
        return true;
      } else {
        console.log('‚ùå Direct driver connection not available');
        return false;
      }
    }
    
    // Make globally available
    window.sendBooking = sendBooking;
    
    // Initialize direct connection
    initializeDriverConnection();
    
    // Example booking function - can be called from console for testing
    window.testBooking = function() {
      return window.farezyDriverService.requestRide({
        passengerName: 'John Smith',
        passengerPhone: '+447123456789',
        pickupAddress: 'London Eye, Westminster, London',
        destinationAddress: 'Big Ben, Westminster, London',
        pickupLat: 51.5033,
        pickupLng: -0.1196,
        destinationLat: 51.5007,
        destinationLng: -0.1246,
        estimatedFare: 15.50,
        distance: 2.5,
        serviceType: 'standard'
      });
    };

    // Enhanced Direct WebSocket Connection
    let driverConnection = null;
    
    function connectToDriverApp() {
      driverConnection = new WebSocket('wss://farezydriver.replit.app/ws');
      
      driverConnection.onopen = function() {
        console.log('Connected to driver network');
        driverConnection.send(JSON.stringify({
          type: 'register',
          data: { userType: 'passenger', userId: 999999 }
        }));
      };
      
      driverConnection.onmessage = function(event) {
        try {
          const message = JSON.parse(event.data);
          console.log('üì® Direct message from driver app:', message);
          
          if (message.type === 'registered') {
            console.log('‚úÖ Successfully registered with driver network');
          } else if (message.type === 'booking_accepted') {
            console.log('‚úÖ Driver accepted booking:', message.data);
            alert('Driver accepted: ' + message.data.driverName);
            // Update UI status
            const statusElement = document.getElementById('booking-status');
            if (statusElement) {
              statusElement.textContent = 'Driver accepted: ' + message.data.driverName;
              statusElement.className = 'notification success';
            }
          } else if (message.type === 'booking_declined') {
            console.log('‚ùå Driver declined booking');
            // Update UI status
            const statusElement = document.getElementById('booking-status');
            if (statusElement) {
              statusElement.textContent = 'Looking for other drivers...';
              statusElement.className = 'notification warning';
            }
          } else if (message.type === 'booking_forwarded') {
            console.log(`üì° Booking forwarded to ${message.driversNotified} drivers`);
            // Update UI status
            const statusElement = document.getElementById('booking-status');
            if (statusElement) {
              if (message.driversNotified > 0) {
                statusElement.textContent = `Sent to ${message.driversNotified} drivers - waiting for response...`;
                statusElement.className = 'notification info';
              } else {
                statusElement.textContent = 'No drivers available right now';
                statusElement.className = 'notification warning';
              }
            }
          } else if (message.error) {
            console.error('‚ùå Error from driver app:', message.error);
            console.error('‚ùå Error details:', message.details);
            console.error('‚ùå Raw message:', message.rawMessage);
            
            console.log('üì± Driver app connection issue - please redeploy driver app with latest code');
          } else {
            console.log('üì• Unknown message type from driver app:', message);
          }
        } catch (error) {
          console.error('‚ùå Error parsing message from driver app:', error, event.data);
        }
      };
      
      driverConnection.onclose = function() {
        console.log('Disconnected from driver network');
        // Attempt to reconnect after 3 seconds
        setTimeout(connectToDriverApp, 3000);
      };
      
      driverConnection.onerror = function(error) {
        console.error('Driver connection error:', error);
      };
    }
    
    // Connect when page loads
    connectToDriverApp();
    
    // Call this when user books a ride
    function sendBookingToDrivers(bookingData) {
      if (driverConnection && driverConnection.readyState === WebSocket.OPEN) {
        // Create booking request in exact format expected by driver app
        const bookingRequest = {
          type: 'booking_request',
          data: {
            passengerId: 999999,
            passengerName: bookingData.name || 'Passenger',
            passengerPhone: bookingData.phone || '+44',
            pickupAddress: bookingData.pickup || 'Current Location',
            destinationAddress: bookingData.destination || 'Destination',
            pickupLat: parseFloat(bookingData.pickupLat) || 51.5074,
            pickupLng: parseFloat(bookingData.pickupLng) || -0.1278,
            destinationLat: parseFloat(bookingData.destinationLat) || 51.5155,
            destinationLng: parseFloat(bookingData.destinationLng) || -0.0922,
            estimatedFare: parseFloat(bookingData.price) || 10.00,
            distance: parseFloat(bookingData.distance) || 2.0,
            serviceType: 'standard',
            timestamp: new Date().toISOString()
          }
        };
        
        console.log('üì§ Sending booking request to drivers:', bookingRequest);
        console.log('üì§ JSON string being sent:', JSON.stringify(bookingRequest));
        console.log('üì§ Connection state:', driverConnection.readyState);
        console.log('üì§ WebSocket URL:', driverConnection.url);
        
        try {
          driverConnection.send(JSON.stringify(bookingRequest));
          console.log('‚úÖ Booking request sent successfully');
          
          // Update UI status
          const statusElement = document.getElementById('booking-status');
          if (statusElement) {
            statusElement.textContent = 'Sent to drivers - waiting for response...';
            statusElement.className = 'notification info';
          }
          
          return true;
        } catch (error) {
          console.error('‚ùå Error sending booking request:', error);
          return false;
        }
      } else {
        console.log('‚ùå Driver connection not available - connection state:', driverConnection ? driverConnection.readyState : 'null');
        return false;
      }
    }
    
    // Make function globally available
    window.sendBookingToDrivers = sendBookingToDrivers;
    
    // Test function for easy console testing
    window.testDirectBooking = function() {
      console.log('üß™ Testing direct booking to driver app...');
      return sendBookingToDrivers({
        name: 'John Smith',
        phone: '+447123456789',
        pickup: 'London Eye, Westminster, London',
        destination: 'Big Ben, Westminster, London',
        pickupLat: 51.5033,
        pickupLng: -0.1196,
        destinationLat: 51.5007,
        destinationLng: -0.1246,
        price: 15.50,
        distance: 2.5
      });
    };
    
    // Simple test to check connection status
    window.checkDriverConnection = function() {
      console.log('üîç Driver connection status:');
      console.log('- driverConnection exists:', !!driverConnection);
      console.log('- Connection state:', driverConnection ? driverConnection.readyState : 'null');
      console.log('- WebSocket.OPEN =', WebSocket.OPEN);
      console.log('- WebSocket.CONNECTING =', WebSocket.CONNECTING);
      console.log('- WebSocket.CLOSING =', WebSocket.CLOSING);
      console.log('- WebSocket.CLOSED =', WebSocket.CLOSED);
      
      if (driverConnection && driverConnection.readyState === WebSocket.OPEN) {
        console.log('‚úÖ Driver connection is ACTIVE and ready');
      } else {
        console.log('‚ùå Driver connection is NOT ready');
      }
    };
    
    // Add functions to global scope immediately
    console.log('‚úÖ Test functions loaded - you can now use:');
    console.log('   checkDriverConnection()');
    console.log('   testDirectBooking()');
    console.log('   testBooking()');
    
    // Test that functions are actually available
    setTimeout(() => {
      if (typeof window.checkDriverConnection === 'function') {
        console.log('‚úÖ checkDriverConnection is ready');
      } else {
        console.log('‚ùå checkDriverConnection not found');
      }
    }, 1000);
  </script>
  </body>
</html>
